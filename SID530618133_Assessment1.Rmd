---
title: "DATA3888 Reef Assignment"
output: 
  html_document:
    theme: cerulean
    toc: yes
    toc_float:
      collapsed: true
date: "2025-03-11"
author: "530618133"
bibliography: citations.bib
---

```{r, include=FALSE}
# These are all the added libraries for this project.
library(viridis)
library(tidyverse)
library(ncdf4)
library(ggmap)
library(gridExtra)
library(tidyverse)
library(class)
library(cvTools)
library(randomForest)
library(caret)
library(RNetCDF)
library(sf)
library(lubridate)

# Here is the google key I've used to run the projects ggmaps.
register_google(key = "AIzaSyAnwb9-OeK8El-HX0ZP19N437-G6chspAU", write = TRUE)
```

![Turtle in Coral Reef Image (from Pixabay)](turtleInReef.jpg)

# Outline
For this project we will be looking into an unprecedented major coral bleaching event. One client has asked us to first assess a claim in regards to Tropical Mid-Lateral reefs having higher probabilities of Coral Bleaching in this time. Furthermore, a second client asked us to assess whether environmental variables measured four years prior are less, equal, or more useful than environmental variables measured at the same time to predict coral bleaching. This report analyses the claim through various maps and a line chart in Part One, and Random Forest classifications assess the second clients query.

# Part One

## Introduction

Our client asked us to explore the claim that "Tropical Mid-Lateral Reefs have a higher probability of Coral Bleaching between 2014-2017 (time of the bleaching event)". We aim to do so with a plethora of visualizations, and if we believe this to be the case, we aim to explore why.

## Data Wrangling Processes
Throughout this HTML file, we have tried to optimize and clean the interwoven R code where necessary reflecting on it where needed. We have also left comments to describe what variables mean, and have a designated R code chunk for cleaning of data at the top of the Markdown file.

## Evaluating the Claim

### Maps for Yearly Exploration of Bleaching

First we wanted to explore via maps whether each reef has above average coral bleaching occurring, with reference to whether they are in the tropical mid-latitude zone.

```{r, include=FALSE}
# This chunk loads in data for the two parts and cleans where necessary.

# Part One
# This loads in the csv file for part one's client.
reefCortadData <- read.csv("Reef_Check_with_cortad_variables_with_annual_rate_of_SST_change.csv")
# We kept only columns we ended up using after we finished part one to speed up the data gathering process.
reefCortadData
reefCortadData <- reefCortadData[, c("Reef.Name", "Year", "Latitude.Degrees", "Longitude.Degrees","Average_bleaching", "TSA")]
# The client required data from years 2014-2017 so we filtered:
reefCortadDataYears <- filter(reefCortadData, Year >= 2014 & Year < 2018)

# Part Two
```

```{r, echo=FALSE}
# In this chunk I produce 4 plots for each year as required by client to analyse whether zone affects probability of bleaching.

plots <- list()

# We iterate through a loop for each year
for (x in 2014:2017) {
  # We generate a year model as seen for each year which provides ggplot all info it needs to produce a map plot for that year.
  reefCortadDataYears <- filter(reefCortadData, Year == x)
  year_model <- reefCortadDataYears[, c("Reef.Name", "Year", "Latitude.Degrees", "Longitude.Degrees","Average_bleaching")]
  year_model <- year_model %>% distinct(Reef.Name, Year, Latitude.Degrees, Longitude.Degrees, Average_bleaching)
  year_model <- year_model %>% arrange(!(Average_bleaching <= 4.32))
          
  # We generate a plot for that year with the given information regarding year model and plot info below to illustrate whether the average bleaching is above average, with red lines to identify the tropical midlatitude.
  plot <- ggplot()+geom_polygon(data =map_data("world"), aes(x=long, y = lat, group = group), alpha=0.3)+
  geom_point(data = year_model, alpha = 0.5, aes(y=Latitude.Degrees, x= Longitude.Degrees,
    color=Average_bleaching>4.32), size=4) +  geom_hline(yintercept = -15, color = "red", linetype = "dashed", linewidth = 1)+  geom_hline(yintercept = 15, color = "red", linetype = "dashed", linewidth = 1)+scale_colour_viridis_d(option = "D") + theme_minimal() +  theme(
      panel.background = element_rect(color = "black"), plot.background = element_rect( color = NA)) + ggtitle(paste("Year:", x)) + labs(color = "Average", shape = "Reef Above Mean") + xlab("Longitude") + ylab("Latitude")
  
  # We then append this plot to the plots list above.
  plots[[as.character(x)]] <- plot
}

# Here we essentially print the plethora of plots in a grid.
grid.arrange(grobs = plots, ncol = 2, top = "Comparing Reefs' Average Bleaching by Zone")
```

Mid-latitude zones identified with red lines.

As can be seen in the above maps, there are clear trends despite a year (2015) where there was higher bleaching on average for outside the mid-latitude zone, it appeared there was consistently a greater average bleaching per year for reefs in the mid-latitude zones compared to in-between zones (15-20 above or below the equator) and outside mid-latitude zones. 

### Simple Line Chart showing Average Bleaching in Zones by Year

Despite maps above suggesting above more likely average bleaching in mid-latitude zones in 2014, 2016, 2017, we felt a line chart would further add to the story in demonstrating our suspicions. 

```{r, echo=FALSE}
reefCortadDataYears <- filter(reefCortadData, Year > 2013)

tsa_model <- reefCortadDataYears[, c("Reef.Name", "Year", "Latitude.Degrees", "Longitude.Degrees","Average_bleaching")]

tsa_model <- transform(tsa_model, in_zone = ifelse(abs(Latitude.Degrees)<20, "Inside Midlatitude Zone", "Outside Midlatitude Zone"))

tsa_model$in_zone <- as.factor(tsa_model$in_zone)
  
comparing_tsa <- tsa_model[, c("Year","in_zone", "Average_bleaching")]

p <- comparing_tsa %>% group_by(Year, in_zone) %>%
  summarise(average_value = mean(Average_bleaching, na.rm=TRUE), .groups = "drop")

ggplot(p, aes(x=Year, y = average_value, color = in_zone)) + geom_line(linewidth = 3) + scale_colour_viridis_d(option = "D") + ggtitle("Comparing Average Bleaching with Years and Zone")
```

Higher averages of bleaching for mid-latitude reefs are made clear here apart from 2015. 

In 2014 it seems there was a high average of coral bleaching across Reefs in the Tropical Midlatitude zone, compared to the other zones. We felt this was due to a minor El Nino event in the Pacfic Ocean as claimed by PMEL.NOAA.GOV that only lasted between 2014-15. This indicates a higher probability of coral bleaching for Tropical Midlatitude zones rather than outer zones in 2014.

In 2015 average bleaching was higher outside the tropical midlatitude. We felt this may have been due to the "nothing" time between the minor and major El Nino events where there wasn't anything major, and natural variations with a more rapidly warming climate for outside the midlatitude.

```{r, echo=FALSE}
reefCortadDataYears <- filter(reefCortadData, Year > 2013)

tsa_model <- reefCortadDataYears[, c("Reef.Name", "Year", "Latitude.Degrees", "Longitude.Degrees","Temperature_Mean")]

tsa_model <- transform(tsa_model, in_zone = ifelse(abs(Latitude.Degrees)<20, "Inside Midlatitude Zone", "Outside Midlatitude Zone"))

tsa_model$in_zone <- as.factor(tsa_model$in_zone)
  
comparing_tsa <- tsa_model[, c("Year","in_zone", "Temperature_Mean")]

p <- comparing_tsa %>% group_by(Year, in_zone) %>%
  summarise(average_value = mean(Temperature_Mean, na.rm=TRUE), .groups = "drop")

ggplot(p, aes(x=Year, y = average_value, color = in_zone)) + geom_line(linewidth = 3) + scale_colour_viridis_d(option = "D") + ggtitle("Comparing Average Reef Temperature Mean with Years and Zone")
```

In 2016 as seen the El Nino event was in full force, with Tropical midlatitude zones being hit slightly harder than outer zones, with almost a 5 average of coral bleaching for midlatitude reefs compared to approximately 4.3 for outer zones. Clearly a huge spike from the prior two years however, and both were hit hard. This again indicates a higher probability of coral bleaching for Tropical Midlatitude zones rather than outer zones in 2016.

In 2017 it appears after the El Nino event while both zones Reefs recovered, the mid-latitude zones still had higher average bleaching (3) compared to around 1.3 for outside. This indicates a higher probability of coral bleaching for Tropical Midlatitude zones rather than outer zones in 2017.

### Mean Thermal Stress Anomalies Exploration
Furthermore I wanted to explore Thermal Stress Anomalies.

```{r, echo=FALSE}
tsa_model <- reefCortadDataYears[, c("Reef.Name", "Latitude.Degrees", "Longitude.Degrees", "TSA_Mean")]
tsa_model <- tsa_model %>% distinct(Reef.Name, Latitude.Degrees, Longitude.Degrees, TSA_Mean)

tsa_model <- transform(tsa_model, in_zone = ifelse(abs(Latitude.Degrees)<20 & abs(Latitude.Degrees)>15, "Inbetween", ifelse(abs(Latitude.Degrees)<15, "Inside Midlatitude Zone", "Outside Midlatitude Zone")))
```

```{r, echo=FALSE}
tsa_model$Above_301 <- tsa_model$TSA_Mean > -1.73
tsa_model$in_zone <- as.factor(tsa_model$in_zone)

world_map <- map_data("world")
ggplot()+geom_polygon(data =world_map, aes(x=long, y = lat, group = group), alpha=0.3)+
geom_point(data = tsa_model, alpha = 0.4, aes(y=Latitude.Degrees, x= Longitude.Degrees,
  shape=Above_301, color = in_zone), size=4) + scale_colour_viridis_d(option = "D") + theme_minimal() +  theme(
    panel.background = element_rect(color = "black"), plot.background = element_rect(color = NA)
  ) + ggtitle("Map displaying Coral Reefs Checking above average Thermal Stress Anomalies") + labs(color = "In Midlatititude Zone", shape = "Reef Above Mean") + xlab("Longitude") + ylab("Latitude")
```
What this means:

### A cause for concern 
```{r, echo=FALSE}
reefCortadDataYears <- filter(reefCortadData, Year > 2013)

tsa_model <- reefCortadDataYears[, c("Reef.Name", "Year", "Latitude.Degrees", "Longitude.Degrees","Diversity")]

tsa_model <- transform(tsa_model, in_zone = ifelse(abs(Latitude.Degrees)<20, "Inside Midlatitude Zone", "Outside Midlatitude Zone"))

tsa_model$in_zone <- as.factor(tsa_model$in_zone)
  
comparing_tsa <- tsa_model[, c("Year","in_zone", "Diversity")]

p <- comparing_tsa %>% group_by(Year, in_zone) %>%
  summarise(average_value = mean(Diversity, na.rm=TRUE), .groups = "drop")

ggplot(p, aes(x=Year, y = average_value, color = in_zone)) + geom_line(linewidth = 3) + scale_colour_viridis_d(option = "D") + ggtitle("Comparing Average Reef Diversity with Years and Zone")
```
DADADA

```{r, echo=FALSE}
reefCortadDataYears <- filter(reefCortadData, Year > 20)

tsa_model <- reefCortadDataYears[, c("Reef.Name", "Year", "Latitude.Degrees", "Longitude.Degrees","Temperature_Mean")]

tsa_model <- transform(tsa_model, in_zone = ifelse(abs(Latitude.Degrees)<20, "Inside Midlatitude Zone", "Outside Midlatitude Zone"))

tsa_model$in_zone <- as.factor(tsa_model$in_zone)
  
comparing_tsa <- tsa_model[, c("Year","in_zone", "Temperature_Mean")]

p <- comparing_tsa %>% group_by(Year, in_zone) %>%
  summarise(average_value = mean(Temperature_Mean, na.rm=TRUE), .groups = "drop")

ggplot(p, aes(x=Year, y = average_value, color = in_zone)) + geom_line(linewidth = 3) + scale_colour_viridis_d(option = "D") + ggtitle("Comparing Average Reef Diversity with Years and Zone")
```

### Conlusion
We think the claim is valid as there were clear signs of 

## Analysing Factors
But I wanted to explore why this was the case. After some data exploration, it appeared temperature seemed to play a significant role in the coral bleaching. As seen in the below map, there was clearly a temperature difference between mid-latitude and in between zones, and outside mid-latitude zones. More details below.

### Mean Temperature Exploration
dadada

```{r, echo=FALSE}
tsa_model <- reefCortadDataYears[, c("Reef.Name", "Latitude.Degrees", "Longitude.Degrees", "Temperature_Mean")]
tsa_model <- tsa_model %>% distinct(Reef.Name, Latitude.Degrees, Longitude.Degrees, Temperature_Mean)

tsa_model <- transform(tsa_model, in_zone = ifelse(abs(Latitude.Degrees)<20 & abs(Latitude.Degrees)>15, "Inbetween", ifelse(abs(Latitude.Degrees)<15, "Inside Midlatitude Zone", "Outside Midlatitude Zone")))
```

```{r, echo=FALSE}
tsa_model$Above_301 <- tsa_model$Temperature_Mean > 301
tsa_model$in_zone <- as.factor(tsa_model$in_zone)

world_map <- map_data("world")
ggplot()+geom_polygon(data =world_map, aes(x=long, y = lat, group = group), alpha=0.3)+
geom_point(data = tsa_model, alpha = 0.4, aes(y=Latitude.Degrees, x= Longitude.Degrees,
  shape=Above_301, color = in_zone), size=4) + scale_colour_viridis_d(option = "D") + theme_minimal() +  theme(
    panel.background = element_rect(color = "black"), plot.background = element_rect(color = NA)
  ) + ggtitle("Map displaying Mean Temperature of Coral Reefs analysed from study") + labs(color = "In Midlatititude Zone", shape = "Reef Above Mean") + xlab("Longitude") + ylab("Latitude")
```

This above map shows dadada

# Part 2

## Introduction
dadada

## Visualisations for Current Year Data
dadada
```{r, echo=FALSE}
world = map_data("world")

eReefs_nc = nc_open(
"https://thredds.ereefs.aims.gov.au/thredds/dodsC/
GBR4_H2p0_B3p1_Cq3b_Dhnd/annual.nc?zc[1],
latitude[0:1:722],longitude[0:1:490],
temp[0:1:9][1][0:1:722][0:1:490],
TOTAL_NITROGEN[0:1:9][1][0:1:722][0:1:490],
MA_N[0:1:9][0:1:722][0:1:490],
PH[0:1:9][1][0:1:722][0:1:490],
salt[0:1:9][1][0:1:722][0:1:490],
time[0:1:9]")

# Longitude and Latitude
lat = ncdf4::ncvar_get(eReefs_nc, "latitude")
long = ncdf4::ncvar_get(eReefs_nc, "longitude")

# Time
time = ncdf4::ncvar_get(eReefs_nc, "time")
tunits = ncdf4::ncatt_get(eReefs_nc, "time", "units")
cf = CFtime::CFtime(tunits$value, calendar = "standard", time)
timestamps = CFtime::as_timestamp(cf) 
timestamps = as.Date(timestamps, format = "%Y-%m-%d") 

# Explanatory variables
temp = ncdf4::ncvar_get(eReefs_nc, "temp")
salt = ncdf4::ncvar_get(eReefs_nc, "salt")
total_n = ncdf4::ncvar_get(eReefs_nc, "TOTAL_NITROGEN")
ma_n = ncdf4::ncvar_get(eReefs_nc, "MA_N")
ph = ncdf4::ncvar_get(eReefs_nc, "PH")

# Convert data to data.frame
eReefs_df = expand.grid(long = long, lat = lat, time = timestamps) %>%
    mutate(temp = as.vector(temp), salt = as.vector(salt), total_n = as.vector(total_n), ma_n = as.vector(ma_n), ph = as.vector(ph))

# filter out when temp or salt is NaN
eReefs_noNan = eReefs_df |>
    filter(!is.nan(temp), !is.nan(salt))

bleachingData <- read.csv("bleachingSurveys.csv")
bleaching_sf = st_as_sf(bleachingData, coords = c("longitude", "latitude"), crs = 4326)

eReefs_sf = st_as_sf(eReefs_noNan, coords = c("long", "lat"), crs = 4326)

joined_sf = st_join(bleaching_sf, eReefs_sf, join = st_is_within_distance, dist = 1000,
    left = TRUE)

joined_contemporary
joined_contemporary <- joined_sf %>% filter(year(surveyDate) == year(time))

joined_prior <- joined_sf %>% filter(
  (year(time) == 2011 & year(surveyDate) == 2015) |
  (year(time) == 2012 & year(surveyDate) == 2016) |
  (year(time) == 2013 & year(surveyDate) == 2017)
)
```

```{r, echo=FALSE}
set.seed(3888)
# Randomly split the data into training (70%) and testing (30%) sets
train_index <- caret::createDataPartition(joined_contemporary$bleachCat, p = 0.7, list = FALSE)

train_data <- joined_contemporary[train_index, ]
test_data <- joined_contemporary[-train_index, ]
train_data$bleachCat <- as.factor(train_data$bleachCat)

# Fit a random forest model to training data
rf_model <- randomForest(bleachCat ~ temp + salt + total_n + ma_n + ph, data = train_data)
rf_model
```

```{r, echo=FALSE}
set.seed(3888)
# Make predictions on testing data
predictions <- predict(rf_model, newdata = test_data)
# Convert both to factors
test_data$bleachCat <- as.factor(test_data$bleachCat)
predictions <- as.factor(predictions)

# Ensure levels match
predictions <- factor(predictions, levels = levels(test_data$bleachCat))

# Generate confusion matrix
cm <- confusionMatrix(predictions, test_data$bleachCat)
cm
``` 

## Predicted Data
dadada
```{r, echo=FALSE}
set.seed(3888)
test_data$predicted <- predictions
test_data <- st_as_sf(test_data)

# Predicted bleaching map
ggplot(data = test_data) + geom_sf(aes(fill = predicted), shape = 21, size = 3, color = "black") +
    theme_classic() + scale_fill_brewer(palette = "Blues") + labs(fill = "Predicted Bleaching Category",
    x = "Longitude", y = "Latitude")
```
### Confusion Matrix and Accuracy
dadada
```{r}
print(cm)
```
```{r}
# Create a new column indicating if prediction is correct or not
test_data$agreement <- ifelse(test_data$bleachCat == test_data$predicted, "Correct",
    "Incorrect")
test_data$agreement <- factor(test_data$agreement, levels = c("Correct", "Incorrect"))

# Predicted vs observed outcomes on the map
ggplot(test_data) + geom_sf(aes(fill = agreement), shape = 21, size = 3, color = "black") +
    scale_fill_manual(values = c(Correct = "green", Incorrect = "red")) + labs(fill = "Predicted Outcome",
    x = "Lontitude", y = "Latitude") + theme_classic()
```

## Visualisations for Current Year Data
dadada
```{r, echo=FALSE}
set.seed(3888)

# Randomly split the data into training (70%) and testing (30%) sets
train_index <- caret::createDataPartition(joined_prior$bleachCat, p = 0.7, list = FALSE)
train_data <- joined_prior[train_index, ]
test_data <- joined_prior[-train_index, ]
train_data$bleachCat <- as.factor(train_data$bleachCat)

# Fit a random forest model to training data
rf_model <- randomForest(bleachCat ~ temp + salt + total_n + ma_n + ph, data = train_data)
rf_model
```

```{r, echo=FALSE}
set.seed(3888)
# Make predictions on testing data
predictions <- predict(rf_model, newdata = test_data)

# Convert both to factors
test_data$bleachCat <- as.factor(test_data$bleachCat)
predictions <- as.factor(predictions)

# Ensure levels match
predictions <- factor(predictions, levels = levels(test_data$bleachCat))

# Generate confusion matrix
cm <- confusionMatrix(predictions, test_data$bleachCat)
cm
```

### Predicted Data
dadada
```{r, echo=FALSE}
test_data$predicted <- predictions
test_data <- st_as_sf(test_data)

# Predicted bleaching map
ggplot(data = test_data) + geom_sf(aes(fill = predicted), shape = 21, size = 3, color = "black") +
    theme_classic() + scale_fill_brewer(palette = "Blues") + labs(fill = "Predicted Bleaching Category",
    x = "Longitude", y = "Latitude")
```
### Confusion Matrix and Accuracy Diagram
dadada
```{r}
print(cm)
```

```{r, echo=FALSE}
# Create a new column indicating if prediction is correct or not
test_data$agreement <- ifelse(test_data$bleachCat == test_data$predicted, "Correct",
    "Incorrect")
test_data$agreement <- factor(test_data$agreement, levels = c("Correct", "Incorrect"))

# Predicted vs observed outcomes on the map
ggplot(test_data) + geom_sf(aes(fill = agreement), shape = 21, size = 3, color = "black") +
    scale_fill_manual(values = c(Correct = "green", Incorrect = "red")) + labs(fill = "Predicted Outcome",
    x = "Lontitude", y = "Latitude") + theme_classic()
```

## Conclusion
dadada

# Summary
dadada